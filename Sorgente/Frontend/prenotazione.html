<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Prenotazione</title>
  <link rel="stylesheet" href="cgi-bin/common/bootstrap.css" />
  <link rel="stylesheet" href="cgi-bin/common/fontawesome.css" />
  <link rel="stylesheet" href="cgi-bin/pnotify/PNotify.css" />
  <link rel="stylesheet" href="cgi-bin/pnotify/PNotifyBrightTheme.css" />
  <link rel="stylesheet" href="cgi-bin/datatable/datatables.css" />
  <link rel="stylesheet" href="cgi-bin/common/general.css" />
  <script src="cgi-bin/common/jquery.js"></script>
  <script src="cgi-bin/common/bootstrap.js"></script>
  <script src="cgi-bin/common/fontawesome.js"></script>
  <script src="cgi-bin/pnotify/PNotify.js"></script>
  <script src="cgi-bin/datatable/datatables.js"></script>
  <script src="cgi-bin/common/general.js"></script>
</head>

<body>
  <div class="container-fluid main-content mt-2">
    <div class="row text-center">
      <div class="col-12">
        <div id="wDivReservationStatus" class="alert alert-primary" role="alert">
        </div>
      </div>
    </div>

    <div id="wDivSectionSelector" class="row justify-content-center">
      <div class="col-3 col-lg-2">
        <button data-scope="anagrafica" class="btn btn-primary active w-100" onclick="showSection(this.getAttribute('data-scope'))">
          <span class="fas fa-user-alt fa-3x"></span>
          <br />
          <span class="fw-bold">Anagrafica</span>
        </button>
      </div>
      <div class="col-3 col-lg-2">
        <button data-scope="esami" class="btn w-100" onclick="showSection(this.getAttribute('data-scope'))">
          <span class="fas fa-clipboard-list fa-3x"></span>
          <br />
          <span class="fw-bold">Esami</span>
        </button>
      </div>
      <div class="col-3 col-lg-2">
        <button data-scope="appuntamento" class="btn w-100" onclick="showSection(this.getAttribute('data-scope'))">
          <span class="fas fa-calendar-check fa-3x"></span>
          <br />
          <span class="fw-bold">Appuntamento</span>
        </button>
      </div>
      <div class="col-3 col-lg-2">
        <button data-scope="preconferma" class="btn w-100" onclick="showSection(this.getAttribute('data-scope'))">
          <span class="fas fa-check-double fa-3x"></span>
          <br />
          <span class="fw-bold">Controlla e Invia</span>
        </button>
      </div>
    </div>
    <hr class="line-separator-blue" />
    <div id="wDivMessageOverForm" class="row justify-content-center text-center">
      <div class="col-12">
        <div id="wMessage" class="alert">
        </div>
      </div>
    </div>
    <form id="wFormPrenotazione">
      <div id="section-anagrafica">
        <div class="row">
          <div class="col-12">
            <div data-scope="guide" class="alert alert-info" onclick="showHelpAlert(this)" style="cursor: pointer;">
              <small class="text-muted">Clicca su questo box per visualizzare/nascondere la guida</small>
              <div>
                In quest'area inserirai i dati anagrafici relativi alla tua persona. Per favore osserva i seguenti
                vincoli:
                <ul>
                  <li>i campi marcati con il <span class="with-asterisk">simbolo</span> sono obbligatori</li>
                  <li>il codice della tessera sanitaria è lungo 20 caratteri ed è presente sul retro della tessera
                    stessa, in fondo</li>
                  <li>puoi inserire un'e-email se vuoi ricevere il referto direttamente sulla tua casella di posta
                    elettronica</li>
                  <li>dopo aver inviato la prenotazione i tuoi dati anagrafici non potranno variare eccetto l'e-mail
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="row justify-content-around mb-3">
          <div class="col-4 col-xl-2">
            <button type="button" onclick="showSection('esami')"
              class="btn btn-dark w-100 d-none d-md-inline">Successivo</button>
            <button type="button" onclick="showSection('esami')" class="btn btn-dark w-100 d-inline d-md-none"><i
                class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <hr class="line-separator-blue" />
        <div class="row justify-content-center">
          <input id="wPrId" type="text" hidden />
          <div class="col-6 col-xl-2">
            <label class="with-asterisk" for="wPrNome">Nome</label>
            <input id="wPrNome" type="text" class="form-control" maxlength="20" />
          </div>
          <div class="col-6 col-xl-2">
            <label class="with-asterisk" for="wPrCognome">Cognome</label>
            <input id="wPrCognome" type="text" class="form-control" maxlength="20" />
          </div>
          <div class="col-6 col-xl-2">
            <label class="with-asterisk" for="wPrCf">Codice Fiscale</label>
            <input id="wPrCf" type="text" class="form-control" maxlength="16" />
          </div>
          <div class="col-6 col-xl-2">
            <label class="with-asterisk" for="wPrTs">Codice Tessera Sanitaria</label>
            <input id="wPrTs" type="text" class="form-control" maxlength="20" />
          </div>
          <div class="col-6 col-xl-2">
            <label for="wPrEmail">E-mail</label>
            <input id="wPrEmail" type="text" class="form-control"/>
          </div>
        </div>
      </div>

      <div id="section-esami">
        <div class="row">
          <div class="col-12">
            <div data-scope="guide" class="alert alert-info" onclick="showHelpAlert(this)" style="cursor: pointer;">
              <small class="text-muted">Clicca su questo box per visualizzare/nascondere la guida</small>
              <div>
                In quest'area sceglierai a quali esami sottoporti. Per favore osserva i seguenti vincoli:
                <ul>
                  <li>è necessario selezionare almeno un esame</li>
                  <li>dopo aver inviato la prenotazione potrai cambiare gli esami selezionati</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <div class="row justify-content-around mb-3">
          <div class="col-4 col-xl-2">
            <button type="button" onclick="showSection('anagrafica')"
              class="btn btn-dark w-100 d-none d-md-inline">Precedente</button>
            <button type="button" onclick="showSection('anagrafica')" class="btn btn-dark w-100 d-inline d-md-none"><i
                class="fas fa-arrow-left"></i></button>
          </div>
          <div class="col-4 col-xl-2">
            <button type="button" onclick="showSection('appuntamento')"
              class="btn btn-dark w-100 d-none d-md-inline">Successivo</button>
            <button type="button" onclick="showSection('appuntamento')" class="btn btn-dark w-100 d-inline d-md-none"><i
                class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <hr class="line-separator-blue" />
        <div class="block-item block-item-border-red">
          <h2 class="text-center text-lab-red">Esami del sangue</h2>
          <hr class="line-separator-red" />
          <div class="d-flex flex-wrap flex-sm-nowrap">
            <div class="checkbox-group">
              <div class="form-check">
                <input id="emocromo" class="form-check-input" type="checkbox" data-scope="Sangue" value="emocromo" />
                <label for="emocromo" class="form-check-label">Emocromo completo</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Esame dei valori del sangue, compresi
                  globuli rossi, bianchi e piastrine.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="profilo-lipidico" class="form-check-input" type="checkbox" data-scope="Sangue"
                  value="profilo-lipidico" />
                <label for="profilo-lipidico" class="form-check-label">Profilo lipidico</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura dei livelli di colesterolo
                  totale, HDL, LDL e trigliceridi nel sangue.</small>

              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="glicemia" class="form-check-input" type="checkbox" data-scope="Sangue" value="glicemia" />
                <label for="glicemia" class="form-check-label">Glicemia</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura del livello di glucosio nel
                  sangue, importante per il controllo del diabete.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="funzionalita-epatica-sangue" class="form-check-input" type="checkbox" data-scope="Sangue"
                  value="funzionalita-epatica" />
                <label for="funzionalita-epatica-sangue" class="form-check-label">Funzionalità epatica (AST,
                  ALT)</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Valutazione degli enzimi epatici per
                  monitorare la salute del fegato.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="test-tiroide" class="form-check-input" type="checkbox" data-scope="Sangue"
                  value="test-tiroide" />
                <label for="test-tiroide" class="form-check-label">Test della tiroide (TSH, T3, T4)</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Valutazione della funzionalità tiroidea attraverso i livelli
                  di TSH, T3 e T4.</small>
              </div>
            </div>
          </div>
        </div>
        <div class="block-item block-item-border-yellow">
          <h2 class="text-center text-lab-yellow">Esami delle urine</h2>
          <hr class="line-separator-yellow" />
          <div class="d-flex flex-wrap flex-sm-nowrap">
            <div class="checkbox-group">
              <div class="form-check">
                <input id="creatinina" class="form-check-input" type="checkbox" data-scope="Urine" value="creatinina" />
                <label for="creatinina" class="form-check-label">Clearance della creatinina</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura della quantità di creatinina
                  eliminata nelle urine per valutare la funzionalità renale.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="urinocoltura" class="form-check-input" type="checkbox" data-scope="Urine"
                  value="urinocoltura" />
                <label for="urinocoltura" class="form-check-label">Urinocoltura</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Esame delle urine per rilevare e
                  identificare batteri e altri microrganismi.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="proteinuria" class="form-check-input" type="checkbox" data-scope="Urine"
                  value="proteinuria" />
                <label for="proteinuria" class="form-check-label">Proteinuria</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura della quantità di proteine nelle
                  urine, indicativa di problemi renali.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="funzionalita-epatica-urine" class="form-check-input" type="checkbox" data-scope="Urine"
                  value="funzionalita-epatica" />
                <label for="funzionalita-epatica-urine" class="form-check-label">Funzionalità epatica (AST, ALT)</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Valutazione degli enzimi epatici per
                  monitorare la salute del fegato.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="microalbuminuria" class="form-check-input" type="checkbox" data-scope="Urine"
                  value="microalbuminuria" />
                <label for="microalbuminuria" class="form-check-label">Microalbuminuria</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura di piccole quantità di albumina
                  nelle urine, importante per il monitoraggio del diabete e malattie
                  renali.</small>
              </div>
            </div>
          </div>
        </div>

        <div class="block-item block-item-border-green">
          <h2 class="text-center text-lab-green">Esami nutrizionali</h2>
          <hr class="line-separator-green" />
          <div class="d-flex flex-wrap flex-sm-nowrap">
            <div class="checkbox-group">
              <div class="form-check">
                <input id="vitamina-d" class="form-check-input" type="checkbox" data-scope="Nutrizionali"
                  value="vitamina-d" />
                <label for="vitamina-d" class="form-check-label">Test della vitamina D</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura i livelli di vitamina D nel
                  sangue, essenziale per la salute delle ossa e del sistema
                  immunitario.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="vitamina-b12" class="form-check-input" type="checkbox" data-scope="Nutrizionali"
                  value="vitamina-b12" />
                <label for="vitamina-b12" class="form-check-label">Test della vitamina B12</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Determina i livelli di vitamina B12 nel
                  sangue, importante per la produzione di globuli rossi e il funzionamento
                  del sistema nervoso.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="folati" class="form-check-input" type="checkbox" data-scope="Nutrizionali" value="folati" />
                <label for="folati" class="form-check-label">Test dei folati</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura i livelli di folati nel sangue, fondamentali per la
                  sintesi del DNA e la salute del sistema nervoso.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="ferro" class="form-check-input" type="checkbox" data-scope="Nutrizionali" value="ferro" />
                <label for="ferro" class="form-check-label">Test del ferro e della ferritina</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Valuta i livelli di ferro e ferritina
                  nel sangue, cruciali per il trasporto dell'ossigeno e la salute
                  generale.</small>
              </div>
            </div>
            <div class="checkbox-group">
              <div class="form-check">
                <input id="elettroliti" class="form-check-input" type="checkbox" data-scope="Nutrizionali"
                  value="elettroliti" />
                <label for="elettroliti" class="form-check-label">Test degli elettroliti</label>
                <br />
                <small class="form-text text-muted fst-italic">Prezzo 20,00 &euro;</small>
                <br />
                <small class="form-text text-muted">Misura i livelli di elettroliti (sodio,
                  potassio, calcio, magnesio) nel sangue, importanti per l'equilibrio
                  idrico e il funzionamento di nervi e muscoli.</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="section-appuntamento">
        <div class="row">
          <div class="col-12">
            <div data-scope="guide" class="alert alert-info" onclick="showHelpAlert(this)" style="cursor: pointer;">
              <small class="text-muted">Clicca su questo box per visualizzare/nascondere la guida</small>
              <div>
                In quest'area sceglierai data, ora e laboratorio in cui sostenere gli esami scelti. Per favore osserva i
                seguenti vincoli:
                <ul>
                  <li>data e ora devono essere <b>dal lunedì al venerdì, dalle 08:00 alle 18:00</b></li>
                  <li>sia per la prima prenotazione sia per modifica della stessa dovrai scegliere una data a partire
                    dal giorno <u>successivo ad oggi (<span id="_wDateTodayReference"></span>)</u></li>
                  <li>dopo aver inviato la prenotazione potrai variare data, ora e laboratorio a patto che vengano
                    rispettati i punti precedenti</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="row justify-content-around mb-3">
          <div class="col-4 col-xl-2">
            <button type="button" onclick="showSection('esami')"
              class="btn btn-dark w-100 d-none d-md-inline">Precedente</button>
            <button type="button" onclick="showSection('esami')" class="btn btn-dark w-100 d-inline d-md-none"><i
                class="fas fa-arrow-left"></i></button>
          </div>
          <div class="col-4 col-xl-2">
            <button type="button" onclick="showSection('preconferma')"
              class="btn btn-dark w-100 d-none d-md-inline">Successivo</button>
            <button type="button" onclick="showSection('preconferma')" class="btn btn-dark w-100 d-inline d-md-none"><i
                class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <hr class="line-separator-blue" />
        <div class="row justify-content-center">
          <div class="col-6 col-md-6 col-xl-2">
            <label for="wPrDataOra">Data e ora</label>
            <input id="wPrDataOra" type="datetime-local" class="form-control" />
          </div>
          <div class="col-6 col-md-6 col-xl-2">
            <label for="wPrLaboratorio">Laboratorio</label>
            <select id="wPrLaboratorio" class="form-select">
              <option value="Lecce - Via Rossi 10" selected>Lecce - Via Rossi 10</option>
              <option value="Lecce - Via Verdi 21">Lecce - Via Verdi 21</option>
              <option value="Lecce - Via Bianchi 3/b">Lecce - Via Bianchi 3/b</option>
            </select>
          </div>
        </div>
      </div>

      <div id="section-preconferma">
        <div class="row">
          <div class="col-12">
            <div data-scope="guide" class="alert alert-info" onclick="showHelpAlert(this)" style="cursor: pointer;">
              <small class="text-muted">Clicca su questo box per visualizzare/nascondere la guida</small>
              <div>
                In quest'area sarà fornito un riassunto della prenotazione prima di inviarla. Per favore osserva i
                seguenti vincoli:
                <ul>
                  <li>verifica con attenzione i dati forniti</li>
                  <li>prima dell'invio è necessario spuntare la casella per confermare la correttezza e veridicità dei
                    dati</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12">
            <div id="wDivPreviewPrenotazione"></div>
          </div>
        </div>
        <div class="row justify-content-center text-center">
          <div class="col-12">
            <input id="wCheckConfirmPr" class="form-check-input" type="checkbox" />
            <label for="wCheckConfirmPr" class="form-check-label fw-bold text-lab-blue">Confermo la validità e
              veridicità dei dati inseriti</label>
          </div>
        </div>
        <hr class="line-separator-blue" />
        <div class="row justify-content-around mb-3">
          <div class="col-4 col-xl-2">
            <button type="button" onclick="showSection('appuntamento')"
              class="btn btn-dark w-100 d-none d-md-inline">Precedente</button>
            <button type="button" onclick="showSection('appuntamento')" class="btn btn-dark w-100 d-inline d-md-none"><i
                class="fas fa-arrow-left"></i></button>
          </div>
          <div id="wDivBtnReset" class="col-4 col-xl-2">
            <button type="reset" class="btn btn-warning w-100 d-none d-md-inline" onclick="generatePromptModal(
                            'Continuando cancellerai i valori inseriti. Confermi?',  
                            function () {
                              resetForm();
                            })">Reset</button>
            <button type="reset" class="btn btn-warning w-100 d-inline d-md-none" onclick="generatePromptModal(
                              'Continuando cancellerai i valori inseriti. Confermi?',  
                              function () {
                                resetForm();
                              })"><i class="fas fa-redo"></i></button>
          </div>
          <div class="col-4 col-xl-2">
            <button name="wBtnSend" type="button" onclick="upsertReservation()"
              class="btn btn-success w-100 d-none d-md-inline">Invia</button>
            <button name="wBtnSend" type="button" onclick="upsertReservation()"
              class="btn btn-success w-100 d-inline d-md-none"><i class="far fa-check-circle"></i></button>
          </div>
        </div>
      </div>
    </form>
  </div>
  <script>
    var isNewReservation = true;
    var existingReservationData;

    $(document).ready(async function () {
      $("#wDivMessageOverForm, #wFormPrenotazione").hide();
      var params = new URLSearchParams(window.location.search);
      var id = params.get("id");
      var cf = params.get("cf");
      var ts = params.get("ts");
      if (id != null && cf != null && ts != null) {
        var response = await executeApiCall("GET", API_GET_RESERVATION, { id: id, cf: cf, ts: ts });
        if (hasHttpSuccessCode(response.code) == false) {
          showAlertMessageOverForm(true, response.error_message);
          return;
        }
        //Salva i dati nella variabile globale per poter accedere da ogni sezione della pagina
        existingReservationData = response.payload;
        isNewReservation = false;

        //Controlla se la data di prenotazione è inferiore ad ora (prenotazione scaduta)
        if (getDateTimeFromString(existingReservationData.dataOraPrenotazione) < new Date()) {
          showAlertMessageOverForm(true, `La prenotazione è scaduta il ${formatDateDDMMYYYY(existingReservationData.dataOraPrenotazione)} e non è possibile apportare modifiche.`);
          return;
        }

        //Riempi i campi con i dati tornati dall'API
        fillFormWithReservationData();

        //Nascondi div con pulsanti reset form
        $("#wDivBtnReset").hide();
      }
      else
      {
        //Visualizza div con pulsanti reset form
        $("#wDivBtnReset").show();
      }

      $("#wDivMessageOverForm").hide();
      $("#wFormPrenotazione, #wDivSectionSelector, #wDivReservationStatus").show();

      showSection("anagrafica", "close");
      showReservationStatus();

      $("#_wDateTodayReference").text(new Date().toLocaleDateString());
    });


    function showAlertMessageOverForm(isError, message = "") {
      $("#wFormPrenotazione, #wDivSectionSelector, #wDivReservationStatus").hide();
      $("#wDivMessageOverForm").show();

      clearChildrenNodes("wMessage");
      var alertTag;
      var alertClass;
      if (isError) {
        alertTag = `<h4 class="fw-bold">Errore: ${message}</h4>`;
        alertClass = "alert-danger";
      }
      else {
        alertTag = `<h4 class="fw-bold">${message}</h4>`
        alertClass = "alert-info";
      }

      alertTag += `<br /><a href="prenotazione.html">Inserisci nuova prenotazione</a>`;

      $("#wMessage").append(alertTag).addClass(alertClass);
    }

    //Visualizza stato prenotazione nell'alert
    function showReservationStatus() {
      var status = "Stato: ";
      if (isNewReservation) {
        status += `<b>aggiunta nuova prenotazione</b>`
      }
      else {
        status += `<b>modifica prenotazione (ID ${existingReservationData.id})</b>
                      inserita il <b>${formatDateDDMMYYYY(existingReservationData.dataOraInserimento)} alle ${getHoursMinutesFromDateTime(existingReservationData.dataOraInserimento)}</b> `;
        if (existingReservationData.dataOraModifica != null) {
          status += `e modificata il <b>${formatDateDDMMYYYY(existingReservationData.dataOraModifica)} alle ${getHoursMinutesFromDateTime(existingReservationData.dataOraModifica)}</b>`;
        }
        status += "<br /><a href='prenotazione.html'>Clicca qui per aggiungere una nuova prenotazione</a>"
      }
      clearChildrenNodes("wDivReservationStatus");
      $("#wDivReservationStatus").append(status);
    }

    //Visualizza una sezione specifica, nascondendo le altre e accendendo il pulsante specifico
    function showSection(targetSection) {
      //Rimuovi l'active attuale e cicla nello scope di ogni button di sezione 
      //Saranno nascoste tutte le sezioni tranne quella esplicitamente indicata nel parametro targetSection
      $("button[data-scope]").each(function () {
        var thisSection = $(this).attr("data-scope");
        if (thisSection != targetSection) {
          $(this).removeClass("btn-primary active");
          $(`#section-${thisSection}`).hide();
        }
        else {
          $(this).addClass("btn-primary active");
          $(`#section-${targetSection}`).show();
        }
      });

      //Nascondi div alert guida
      $('div[data-scope="guide"]').each(function () {
        showHelpAlert(this, "close");
      });

      //Rigenera la preview prenotazione quando si seleziona l'area di preconferma
      if (targetSection == "preconferma") {
        previewFormDataBeforeUpsert();
      }
    }

    //Contiene la validazione dei campi di ogni sotto-sezione
    //Ogni sezione richiama la showSection su sé stessa in modo da offrire il focus nell'area di errore, qualora presente
    function preValidateFormSection(section) {
      if (section == "anagrafica") {
        showSection(section);
        var validator;
        if (isNullOrEmpty($("#wPrNome").val())) {
          pushNotification("error", "Il campo nome è vuoto");
          return false;
        }

        if (isNullOrEmpty($("#wPrCognome").val())) {
          pushNotification("error", "Il campo cognome è vuoto");
          return false;
        }

        if (isNullOrEmpty($("#wPrCf").val())) {
          pushNotification("error", "Il campo codice fiscale è vuoto");
          return false;
        }

        validator = validatorCF($("#wPrCf").val());
        if (validator.IsValid == false) {
          pushNotification("error", `Errore nel campo codice fiscale: ${validator.Error}`);
          return false;
        }

        if (isNullOrEmpty($("#wPrTs").val())) {
          pushNotification("error", "Il campo tessera sanitaria è vuoto");
          return false;
        }

        validator = validatorTS($("#wPrTs").val());
        if (validator.IsValid == false) {
          pushNotification("error", `Errore nel campo tessera sanitaria:  ${validator.Error}`);
          return false;
        }

        if (isNullOrEmpty($("#wPrEmail").val()) == false) {
          validator = validatorEmail($("#wPrEmail").val());
          if (validator.IsValid == false) {
            pushNotification("error", `Errore nel controllo e-mail: ${validator.Error}`);
            return false;
          }
        }

      }
      else if (section == "esami") {
        showSection(section);
        var listExams = getExamsSelectedFromCheckboxes();
        if (listExams.length == 0) {
          pushNotification("error", "È necessario selezionare almeno un esame")
          return false;
        }
      }
      else if (section == "appuntamento") {
        showSection(section);
        var dateTime = getDateTimeFromString($("#wPrDataOra").val());
        if (dateTime == null) {
          pushNotification("error", "Data e ora prenotazione non hanno un formato valido");
          return false;
        }

        if (checkReservationIsNextDay(dateTime) == false) {
          pushNotification("error", `La data della prenotazione dev'essere successiva ad oggi`)
          return false;
        }

        if (checkReservationDayRange(dateTime) == false) {
          pushNotification("error", "La data della prenotazione deve essere compresa tra lunedì e venerdì")
          return false;
        }

        if (checkReservationTimeRange(dateTime) == false) {
          pushNotification("error", "L'orario della prenotazione deve essere compreso tra le 08:00 e le 18:00")
          return false;
        }
      }
      else if (section == "preconferma") {
        showSection(section);
        if ($("#wCheckConfirmPr").is(":checked") == false) {
          pushNotification("error", "È necessaria l'esplicita conferma dei dati inseriti prima di inviare la prenotazione")
          return false;
        }
      }

      return true;
    }


    //Verififica se la data passata ha La data della prenotazione nel range valido
    function checkReservationDayRange(dateTime = null) {
      if (dateTime == null)
        return false;

      var day = dateTime.getDay(); // Estremi: Domenica (0) - Sabato (6)
      // Controllo giorno
      if (day < 1 || day > 5)
        return false;

      return true;
    }

    //Verifica se l'orario è nel range valido
    function checkReservationTimeRange(dateTime = null) {
      if (dateTime == null)
        return false;

      var hours = dateTime.getHours();
      if (hours < 8 || hours > 18)
        return false;

      return true;
    }


    //Verifica se la data è uguale o maggiore del giorno successivo ad oggi
    function checkReservationIsNextDay(dateTimeReservation = null) {
      if (dateTimeReservation == null)
        return false;
      
      var dateTimeNextDay = new Date();
      //Usa un dateTimeReservation locale per poter fare un confronto tramite getTime impostando entrambi a mezzanotte
      //Non manipolare direttamente l'oggetto in input in quanto passato per riferimento
      var dateTimeReservationLocal = new Date(dateTimeReservation);
      dateTimeNextDay.setDate(new Date().getDate() + 1);
      dateTimeNextDay.setHours(0, 0, 0, 0);
      dateTimeReservationLocal.setHours(0, 0, 0, 0);
      
      return dateTimeReservationLocal.getTime() >= dateTimeNextDay.getTime();
    }


    //Converte la data da un oggetto stringa
    function getDateTimeFromString(input) {
      var dateTime = new Date(input);
      if (isNaN(dateTime))
        return null;

      return dateTime;
    }

    function resetForm() {
      $("input[id^='wPr'").each(function () {
        $(this).val();
      });
      //Riporta l'utente all'anagrafica
      showSection("anagrafica");
      pushNotification("success", "Tutti i campi sono stati svuotati")
    }


    function fillFormWithReservationData() {
      var data = existingReservationData;
      $("#wFormPrenotazione").show();
      $("#wPrId").val(data.id);
      $("#wPrNome").val(data.nome);
      $("#wPrCognome").val(data.cognome);
      $("#wPrCf").val(data.cf);
      $("#wPrEmail").val(data.email);
      $("#wPrTs").val(data.ts);
      data.listaEsami.forEach(function (item) {
        $('input[type="checkbox"][data-scope="' + item.tipo + '"][value="' + item.nome + '"]').prop("checked", true);
      });
      $("#wPrDataOra").val(data.dataOraPrenotazione);
      $("#wPrLaboratorio").val(data.laboratorio);
      $("#wPrId, #wPrNome, #wPrCognome, #wPrCf, #wPrTs").prop("readonly", true);
    }


    //Gestisce Update oppure Insert in base allo stato della prenotazione attuale. 
    //Questo unifica le validazioni sui campi prima di inviare i dati
    async function upsertReservation() {
      var response = null;

      if (preValidateFormSection("anagrafica") == false ||
          preValidateFormSection("esami") == false ||
          preValidateFormSection("appuntamento") == false ||
          preValidateFormSection("preconferma") == false) {
        return false;
      }

      jsonData =
      {
        "id": $("#wPrId").val(),
        "nome": $("#wPrNome").val(),
        "cognome": $("#wPrCognome").val(),
        "cf": $("#wPrCf").val(),
        "ts": $("#wPrTs").val(),
        "email": $("#wPrEmail").val(),
        "dataOraPrenotazione": $("#wPrDataOra").val(),
        "laboratorio": $("#wPrLaboratorio").val(),
        "listaEsami": getExamsSelectedFromCheckboxes(),
      };

      if (isNewReservation)
        response = await executeApiCall("POST", API_ADD_RESERVATION, {}, JSON.stringify(jsonData));
      else
        response = await executeApiCall("POST", API_UPDATE_RESERVATION, {}, JSON.stringify(jsonData));

      if (hasHttpSuccessCode(response.code) == false) {
        pushNotification("error", response.error_message);
        return;
      }

      showAlertMessageOverForm(false, `Prenotazione ${isNewReservation ? "inviata" : "aggiornata"} correttamente!`)
    }


    //Recupero array delle analisi selezionate dalle checkbox
    function getExamsSelectedFromCheckboxes() {
      var listaEsami = [];
      $('input[type="checkbox"][data-scope]').each(function () {
        if ($(this).is(":checked")) {
          var tipo = $(this).attr("data-scope");
          var nome = $(this).val();
          listaEsami.push({ tipo: tipo, nome: nome });
        }
      });

      return listaEsami;
    }


    //Utility per il recupero del valore di un campo o visualizzazione di stringa vuota. Usato nel RiassuntoPrenotazione
    function getFormFieldValueOrEmpty(field) {
      if (isNullOrEmpty($(field).val()))
        return "";
      else
        return $(field).val();
    }

    function previewFormDataBeforeUpsert() {
      var dataFields = [
        { "FieldName": "wPrNome", "FieldValue": "", "Required": true },
        { "FieldName": "wPrCognome", "FieldValue": "", "Required": true },
        { "FieldName": "wPrTs", "FieldValue": "", "Required": true },
        { "FieldName": "wPrCf", "FieldValue": "", "Required": true },
        { "FieldName": "wPrEmail", "FieldValue": "", "Required": false },
        { "FieldName": "wPrDataOra", "FieldValue": "", "Required": true },
        { "FieldName": "wPrLaboratorio", "FieldValue": "", "Required": true },
      ]

      var isFormCompleted = true;
      for (let i = 0; i < dataFields.length; i++) {
        var value = getFormFieldValueOrEmpty("#" + dataFields[i].FieldName);
        if (value == "" && dataFields[i].Required == true) {
          isFormCompleted = false;
          break;
        }

        dataFields[i].FieldValue = value;
      }

      var selectedExams = getExamsSelectedFromCheckboxes();

      var tag;
      if (isFormCompleted && selectedExams.length > 0) {
        var nome = dataFields.find(field => field.FieldName === "wPrNome").FieldValue;
        var cognome = dataFields.find(field => field.FieldName === "wPrCognome").FieldValue;
        var ts = dataFields.find(field => field.FieldName === "wPrTs").FieldValue;
        var cf = dataFields.find(field => field.FieldName === "wPrCf").FieldValue;;
        var email = dataFields.find(field => field.FieldName === "wPrEmail").FieldValue;
        var laboratorio = dataFields.find(field => field.FieldName === "wPrLaboratorio").FieldValue;
        // Recupera l'elenco degli esami selezionati dalle checkbox
        // Ottieni i tipi di analisi unici
        var uniqueExamTypes = [...new Set(selectedExams.map((exam) => exam.tipo))];
        // Crea una stringa che raggruppa le analisi per tipo
        var groupedExamsString = uniqueExamTypes.reduce((accumulator, tipo) => {
          // Filtra gli esami per tipo e ottieni i nomi
          var examsForType = selectedExams
            .filter((exam) => exam.tipo === tipo)
            .map((exam) => exam.nome)
            .join(", ");

          // Aggiungi il gruppo di esami al risultato accumulato
          accumulator += `<b>${tipo}</b>: ${examsForType} <br />`;
          return accumulator;
        }, "");

        var dataOraPrenotazione = dateTimeSplit(dataFields.find(field => field.FieldName === "wPrDataOra").FieldValue);
        var dataPrenotazione = formatDateDDMMYYYY(dataOraPrenotazione.Date);
        var oraPrenotazione = dataOraPrenotazione.Time;
        var examsResultDelivery;
        if (isNullOrEmpty(email)) {
          examsResultDelivery = `Non è stata fornita alcuna e-mail; gli esiti andranno ritirati al laboratorio indicato oppure 
            <span class="text-lab-blue" style="cursor: pointer" onclick="showSection('anagrafica'); $('#wPrEmail').focus();">clicca qui per aggiungere un'e-email</span>`;
        }
        else {
          examsResultDelivery = `Gli esiti verranno inviati all'e-mail <b>${email}</b>`;
        }

        tag = `
          <div class="alert alert-success">
            <h5 class="text-center fw-bold text-lab-blue">Riepilogo dei dati</h5>
            <p>
              <b>${nome} ${cognome}</b>
              con codice fiscale <b>${cf}</b> e codice tessera sanitaria <b>${ts}</b>
              eseguirà in data <b>${dataPrenotazione}</b> alle ore <b>${oraPrenotazione}</b> presso il laboratorio <b>${laboratorio}</b> i seguenti esami:
              <br />
              ${groupedExamsString}
              <br />
              ${examsResultDelivery}
              <hr />
              Il pagamento della prestazione avverrà nel laboratorio indicato e il costo per gli esami prenotati (${selectedExams.length}) è di <b>${formatCurrency(selectedExams.length * 20)}</b> 
            </p>
          </div>
        `;

        $("#wCheckConfirmPr, [name='wBtnSend']").removeAttr("disabled");
      }
      else {
        tag = `
          <div class="alert alert-danger">
           Errore: non tutti i campi sono stati compilati o sono presenti errori
          </div>
        `;
        $("#wCheckConfirmPr, [name='wBtnSend']").attr("disabled", "disabled");
      }

      clearChildrenNodes("wDivPreviewPrenotazione");
      $("#wDivPreviewPrenotazione").append(tag);
    }
  </script>
</body>

</html>