<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <head>
        <title>Homepage</title>
        <link rel="stylesheet" href="cgi-bin/common/bootstrap.css">
        <link rel="stylesheet" href="cgi-bin/common/fontawesome.css">
        <link rel="stylesheet" href="cgi-bin/pnotify/PNotify.css">
        <link rel="stylesheet" href="cgi-bin/pnotify/PNotifyBrightTheme.css">
        <link rel="stylesheet" href="cgi-bin/datatable/datatables.css">
        <link rel="stylesheet" href="cgi-bin/common/general.css">
        <script src="cgi-bin/common/jquery.js"></script>
        <script src="cgi-bin/common/bootstrap.js"></script>
        <script src="cgi-bin/common/fontawesome.js"></script>
        <script src="cgi-bin/pnotify/PNotify.js"></script>
        <script src="cgi-bin/datatable/datatables.js"></script>
        <script src="cgi-bin/common/general.js"></script>
    </head>
    
    <body>
        <div class="container-fluid main-content mt-2">
          <div class="row">
            <div class="col-12">
              <div data-scope="guide" class="alert alert-info" onclick="showHelpAlert(this)" style="cursor: pointer;">
                <small class="text-muted">Clicca su questo box per visualizzare/nascondere la guida</small>
                <div>
                  In quest'area potrai cercare le tue prenotazioni. Per favore osserva i seguenti vincoli:
                  <ul>
                    <li>i campi marcati con il <span class="with-asterisk">simbolo</span> sono obbligatori</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="row justify-content-center">
                <div class="col-8 col-sm-8 col-md-8 col-lg-4 col-xl-3">
                    <label class="with-asterisk">Codice fiscale</label>
                    <input id="wCf" type="text" class="form-control" maxlength="16">
                </div>
                <div class="col-8 col-sm-8 col-md-8 col-lg-4 col-xl-3">
                    <label class="with-asterisk">Tessera sanitaria</label>
                    <input id="wTs" type="text" class="form-control" maxlength="20">
                </div>
                <div class="col-4 col-sm-4 col-md-4 col-lg-3 col-xl-1 d-flex align-items-end">
                    <button title="Ricerca" type="button" class="btn btn-dark w-100" onclick="getReservationList()"><i class="fas fa-search"></i></button>
                </div>
            </div>
            <hr class="line-separator-blue" />
            <div id="wDivResult">
  
            <table id="wTableResult" class=" w-100 row-border">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Data</th>
                        <th>Ora</th>
                        <th>Laboratorio</th>
                        <th>Esami</th>
                        <th>Modifica</th>
                        <th>Elimina</th>
                    </tr>
                </thead>
            </table>
            </div>
        </div>
    </div>
</body>

<script>
    $(document).ready(function() {
        $("#wDivResult").hide();
        $("#wCf").val("BRSGLC96B09B506O");
        $("#wTs").val("08038000110345678900");

        //Nascondi div alert guida
        $('div[data-scope="guide"]').each(function () {
          showHelpAlert(this, "close");
        });

    });
    
    async function getReservationList() {
        var cf = $("#wCf").val();
        var ts = $("#wTs").val();
        if (!validatorCF(cf))
        {
            pushNotification("error", "Il codice fiscale non è corretto");
            $("#wDivResult").hide();
            return;      
        }
        if (!validatorTS(ts))
        {
            pushNotification("error", "Il codice della tessera sanitaria non è corretto");
            $("#wDivResult").hide();
            return;      
        }

        var response = await executeApiCall("GET", API_GET_RESERVATION_LIST, {"cf": cf, "ts": ts});
       
        if (hasHttpSuccessCode(response.code) == false)
        {
            pushNotification("error", response.error_message);
            $("#wDivResult").hide();
            return;
        }

        $("#wDivResult").show();
        new DataTable('#wTableResult', 
        {
            destroy: true,
            info: false,
            ordering: true,
            paging: false,
            data: response.payload,
            columns: [
                {
                    data: "id",
                },
                {
                    data: "dataOraPrenotazione",
                    render: function (data, type, row) {
                        if (type === "display" || type === "filter")
                        {
                            var dateTime = dateTimeSplit(data);
                            return formatDateDDMMYYYY(dateTime.Date)
                        }

                        return data;
                    }
                },
                {
                    data: "dataOraPrenotazione",
                    render: function (data, type, row) {
                        if (type === "display" || type === "filter")
                        {
                            var dateTime = dateTimeSplit(data);
                            return dateTime.Time
                        }

                        return data;
                    }
                },
                {
                    data: "laboratorio",
                },
                {
                    data: "listaAnalisi",
                    render: function (data, type, row) {
                        if (type === "display" || type === "filter")
                        {
                            var listaAnalisi = data[0].tipo + " " + data[0].nome;
                            return `<button title="Visualizza" type="button" class="btn btn-link" onclick="generateInfoModal('${listaAnalisi}')"><i class="fas fa-list"></i></button>`;
                        }

                        return data;
                    }
                },
                //Tasto modifica prenotazione
                {
                    data: null,
                    render: function (data, type, row) {
                        if (type === "display")
                        {
                            return `<button title="Modifica" type="button" class="btn btn-primary" onclick="editReservation('${row.id}', '${row.cf}', '${row.ts}')"><i class="fas fa-edit"></i></button>`;
                        }

                        return "";
                    }
                },
                //Tasto elimina prenotaazione
                {
                    data: null,
                    render: function (data, type, row) {
                        if (type === "display")
                        {
                            var id = row.id;
                            var cf = row.cf;
                            var ts = row.ts;
                            var handler = function(id, cf, ts) { deleteReservation(id, cf, ts) }
                            return `<button title="Elimina" type="button" class="btn btn-danger" onclick="GeneratePromptModal('Confermi eliminazione?', ${handler})"><i class="fas fa-trash"></i></button>`;
                        }

                        return "";
                    }
                }
            ]
        });
    }

    function editReservation(id, cf, ts)
    {
        window.location.href = `prenotazione.html?id=${id}&cf=${cf}&ts=${ts}`; 
    }

    async function deleteReservation(id, cf, ts)
    {
        var response = await executeApiCall("GET", API_DELETE_RESERVATION, {"id": id, "cf": cf, "ts": ts});
        if (hasHttpSuccessCode(response.code) == false)
        {
            pushNotification("error", response.error_message);
            return;
        }
        else
        {
            pushNotification("success", "Eliminazione effettuata");
        }

        //Ricarica lista
        await getReservationList();
    }
</script>
</html>
